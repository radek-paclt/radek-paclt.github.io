<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>VDI wrapper</title>
   
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>

</head>

<script type="text/javascript">
  const clientId = 'c3853eb7-e2f3-402b-95d3-22491e80c996';
  // Set purecloud objects
  const platformClient = require('platformClient');
  const client = platformClient.ApiClient.instance;
  const conversationsApi = new platformClient.ConversationsApi();
  const notificationsApi = new platformClient.NotificationsApi();
  const usersApi = new platformClient.UsersApi();
  const presenceApi = new platformClient.PresenceApi();

  // Set PureCloud settings
  client.setEnvironment('mypurecloud.de');
  client.setPersistSettings(true, 'cti-toolbar-app');

  // Set local vars
  let CONVERSATION_LIST_TEMPLATE = null;
  let conversationList = {};
  let me, webSocket, conversationsTopic, presenceTopic, notificationChannel, activeCallNumber;

  let applicationUrl = window.location.href;

  $(document).ready(() => {
	client.loginImplicitGrant(clientId, applicationUrl)
		.then(() => {

			// Get authenticated user's info
			return usersApi.getUsersMe({'expand': ["presence"]});
		})
		.then((userMe) => {
			console.log('userMe: ', userMe);
			me = userMe;
			return notificationsApi.postNotificationsChannels();
		})
		.then((channel) => {
			console.log('channel: ', channel);
			notificationChannel = channel;

			// Set up web socket
			webSocket = new WebSocket(notificationChannel.connectUri);
			webSocket.onmessage = handleNotification;

			// Subscribe to authenticated user's conversations
			conversationsTopic = 'v2.users.' + me.id + '.conversations';
      presenceTopic = 'v2.users.' + me.id + '.presence';

			const NotificationBody = [ { id: conversationsTopic }, { id: presenceTopic } ];
			return notificationsApi.putNotificationsChannelSubscriptions(notificationChannel.id, NotificationBody);
		})
		.then((topicSubscriptions) => {
			console.log('topicSubscriptions: ', topicSubscriptions);
		})
		.catch((err) => console.error(err));
});

function handleNotification(message) {
	// Parse notification string to a JSON object
	const notification = JSON.parse(message.data);

	// Discard unwanted notifications
	if (notification.topicName.toLowerCase() === 'channel.metadata') {
		console.info('Ignoring metadata: ', notification);
    return;
	} else if (notification.topicName.toLowerCase() === presenceTopic.toLowerCase()) {
		console.log('Agent status notification: ', notification);
    addAgentStatus('Agent je aktuálně ve stavu ' + notification.eventBody.presenceDefinition.systemPresence);
    return;
	} else if (notification.topicName.toLowerCase() === conversationsTopic.toLowerCase()) {
		console.debug('Notification: ', notification);
    if (isConversationDisconnected(notification.eventBody)) {
      activeCallNumber = '';
    } else {
      var callDirection = '';
      var callNumber = '';

      for (let participant of notification.eventBody.participants) {
        if (participant.calls[0].state === 'connected' && (participant.purpose === 'external' || participant.purpose === 'customer')){
          callDirection = participant.direction;
          callNumber = participant.address;
          break;  
        }
    	};
      
      if (callNumber !== activeCallNumber && callNumber !== ''){
        if (callDirection === 'inbound') {
          console.debug('Příchozí hovor z čísla ' + callNumber);
        } else {
          console.debug('Odchozí hovor na číslo ' + callNumber);
        }
        activeCallNumber = callNumber;
      }
    }
    return;
	} else {
		console.warn('Unknown notification: ', notification);
    return;
  }
}
</script>

<body id="page-top">
  <button class="navbar-toggler navbar-toggler-right text-uppercase font-weight-bold bg-primary text-white rounded" 
  type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"
  onclick="">
    Answer
  </button>
</body>
</html>
